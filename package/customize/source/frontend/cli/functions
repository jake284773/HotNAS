#!/bin/sh

save_network_settings()
{
	netconfig_file="/frontend/config/network"
	
	echo "#!/bin/sh" > "$netconfig_file"
	echo "# Autogenerated file on $(date)" >> "$netconfig_file"
	echo "# DO NOT EDIT!" >> "$netconfig_file"
	echo >> "$netconfig_file"
	
	echo "net_eth0_mode=\"$net_eth0_mode\"" >> "$netconfig_file"
	echo "net_eth0_ip=\"$net_eth0_ip\"" >> "$netconfig_file"
	echo "net_eth0_gateway=\"$net_eth0_gateway\"" >> "$netconfig_file"
	echo "net_eth0_broadcast=\"$net_eth0_broadcast\"" >> "$netconfig_file"
	echo "net_eth0_mode=\"$net_eth0_netmask\"" >> "$netconfig_file"
	echo "net_eth0_mode=\"$net_eth0_domain\"" >> "$netconfig_file"
	echo "net_eth0_dns1=\"$net_eth0_dns1\"" >> "$netconfig_file"
	echo "net_eth0_dns2=\"$net_eth0_dns2\"" >> "$netconfig_file"
	
	chmod +x "$netconfig_file"
}

apply_network_settings()
{
	interfaces_framework="/frontend/config/interfaces_framework"
	interfaces_file="/etc/network/interfaces"
	resolv_file="/etc/resolv.conf"
	
	cat "$interfaces_framework" > "$interfaces_file"
	
	if [ "$net_eth0_mode" == "dhcp" ]
	then
		echo "iface eth0 inet dhcp" >> "$interfaces_file"
	else
		echo "iface eth0 inet static" >> "$interfaces_file"
		echo "address $net_eth0_ip" >> "$interfaces_file"
		echo "gateway $net_eth0_gateway" >> "$interfaces_file"
		echo "broadcast $net_eth0_broadcast" >> "$interfaces_file"
		echo "netmask $net_eth0_netmask" >> "$interfaces_file"
		
		echo "search $net_eth0_domain" > "$resolv_file"
		echo "nameserver $net_eth0_dns1" >> "$resolv_file"
		
		if [ "$net_eth0_dns2" != "" ]
		then
			echo "nameserver $net_eth0_dns2" >> "$resolv_file"
		fi
	fi
}

getcurrent_network_settings()
{		
	net_eth0_mode="$(cat /etc/network/interfaces | grep 'iface eth0' | awk '{print $4}')"
	net_eth0_ip="$(ifconfig eth0 | awk 'NR==2 {print $2}' | cut -d: -f2)"
	net_eth0_gateway="$(route -n | awk 'NR==4 {print $2}')"
	net_eth0_broadcast="$(ifconfig eth0 | awk 'NR==2 {print $3}' | cut -d: -f2)"
	net_eth0_netmask="$(ifconfig eth0 | awk 'NR==2 {print $4}' | cut -d: -f2)"
	net_eth0_domain="$(cat /etc/resolv.conf | grep search | awk 'NR==1 {print $2}')"
	net_eth0_dns1="$(cat /etc/resolv.conf | grep nameserver | awk 'NR==1 {print $2}')"
	net_eth0_dns2="$(cat /etc/resolv.conf | grep nameserver | awk 'NR==2 {print $2}')"
}
